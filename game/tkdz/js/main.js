"use strict";var ctx,wallCtx,grassCtx,tankCtx,overCtx,menu=null,stage=null,map=null,player1=null,player2=null,prop=null,enemyArray=[],bulletArray=[],keys=[],crackArray=[],gameState=GAME_STATE_MENU,level=1,maxEnemy=20,maxAppearEnemy=5,appearEnemy=0,mainframe=0,isGameOver=!1,overX=176,overY=384,emenyStopTime=0,homeProtectedTime=-1,propTime=300;function initScreen(){var e=$("#stageCanvas");ctx=e[0].getContext("2d"),e.attr({width:SCREEN_WIDTH}),e.attr({height:SCREEN_HEIGHT}),wallCtx=$("#wallCanvas")[0].getContext("2d"),grassCtx=$("#grassCanvas")[0].getContext("2d"),$("#wallCanvas").attr({width:SCREEN_WIDTH}),$("#wallCanvas").attr({height:SCREEN_HEIGHT}),$("#grassCanvas").attr({width:SCREEN_WIDTH}),$("#grassCanvas").attr({height:SCREEN_HEIGHT}),tankCtx=$("#tankCanvas")[0].getContext("2d"),$("#tankCanvas").attr({width:SCREEN_WIDTH}),$("#tankCanvas").attr({height:SCREEN_HEIGHT}),overCtx=$("#overCanvas")[0].getContext("2d"),$("#overCanvas").attr({width:SCREEN_WIDTH}),$("#overCanvas").attr({height:SCREEN_HEIGHT}),$("#canvasDiv").css({width:SCREEN_WIDTH}),$("#canvasDiv").css({height:SCREEN_HEIGHT}),$("#canvasDiv").css({"background-color":"#000000"})}function initObject(){menu=new Menu(ctx),stage=new Stage(ctx,level),map=new Map(wallCtx,grassCtx),(player1=new PlayTank(tankCtx)).x=129+map.offsetX,player1.y=385+map.offsetY,(player2=new PlayTank(tankCtx)).offsetX=128,player2.x=256+map.offsetX,player2.y=385+map.offsetY,appearEnemy=0,enemyArray=[],bulletArray=[],keys=[],isGameOver=!(crackArray=[]),overX=176,overY=384,overCtx.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),emenyStopTime=0,homeProtectedTime=-1,propTime=1e3}function gameLoop(){switch(gameState){case GAME_STATE_MENU:menu.draw();break;case GAME_STATE_INIT:stage.draw(),1==stage.isReady&&(gameState=GAME_STATE_START);break;case GAME_STATE_START:drawAll(),(isGameOver||player1.lives<=0&&player2.lives<=0)&&(gameState=GAME_STATE_OVER,map.homeHit(),PLAYER_DESTROY_AUDIO.play()),appearEnemy==maxEnemy&&0==enemyArray.length&&(gameState=GAME_STATE_WIN);break;case GAME_STATE_WIN:nextLevel();break;case GAME_STATE_OVER:gameOver()}}function initMap(){map.setMapLevel(level),map.draw(),drawLives()}function drawLives(){map.drawLives(player1.lives,1),map.drawLives(player2.lives,2)}function drawBullet(){if(null!=bulletArray&&0<bulletArray.length)for(var e=0;e<bulletArray.length;e++){var a=bulletArray[e];a.isDestroyed?(a.owner.isShooting=!1,bulletArray.removeByIndex(e),e--):a.draw()}}function keyEvent(){keys.contain(keyboard.W)?(player1.dir=UP,player1.hit=!1,player1.move()):keys.contain(keyboard.S)?(player1.dir=DOWN,player1.hit=!1,player1.move()):keys.contain(keyboard.A)?(player1.dir=LEFT,player1.hit=!1,player1.move()):keys.contain(keyboard.D)&&(player1.dir=RIGHT,player1.hit=!1,player1.move()),keys.contain(keyboard.UP)?(player2.dir=UP,player2.hit=!1,player2.move()):keys.contain(keyboard.DOWN)?(player2.dir=DOWN,player2.hit=!1,player2.move()):keys.contain(keyboard.LEFT)?(player2.dir=LEFT,player2.hit=!1,player2.move()):keys.contain(keyboard.RIGHT)&&(player2.dir=RIGHT,player2.hit=!1,player2.move())}function addEnemyTank(){if(!(null==enemyArray||enemyArray.length>=maxAppearEnemy||0==maxEnemy)){appearEnemy++;var e=parseInt(3*Math.random()),a=null;0==e?a=new EnemyOne(tankCtx):1==e?a=new EnemyTwo(tankCtx):2==e&&(a=new EnemyThree(tankCtx)),a.x=ENEMY_LOCATION[parseInt(3*Math.random())]+map.offsetX,a.y=map.offsetY,a.dir=DOWN,enemyArray[enemyArray.length]=a,map.clearEnemyNum(maxEnemy,appearEnemy)}}function drawEnemyTanks(){if(null!=enemyArray||0<enemyArray.length)for(var e=0;e<enemyArray.length;e++){var a=enemyArray[e];a.isDestroyed?(enemyArray.removeByIndex(e),e--):a.draw()}0<emenyStopTime&&emenyStopTime--}function drawAll(){tankCtx.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),0<player1.lives&&player1.draw(),0<player2.lives&&player2.draw(),drawLives(),appearEnemy<maxEnemy&&(mainframe%100==0&&(addEnemyTank(),mainframe=0),mainframe++),drawEnemyTanks(),drawBullet(),drawCrack(),keyEvent(),propTime<=0?drawProp():propTime--,0<homeProtectedTime?homeProtectedTime--:0==homeProtectedTime&&(homeProtectedTime=-1,homeNoProtected())}function drawCrack(){if(null!=crackArray&&0<crackArray.length)for(var e=0;e<crackArray.length;e++){var a=crackArray[e];a.isOver?(crackArray.removeByIndex(e),e--,a.owner==player1?player1.renascenc(1):a.owner==player2&&player2.renascenc(2)):a.draw()}}function gameOver(){overCtx.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),overCtx.drawImage(RESOURCE_IMAGE,POS.over[0],POS.over[1],64,32,overX+map.offsetX,overY+map.offsetY,64,32),(overY-=2)<=parseInt(map.mapHeight/2)&&(initObject(),1==menu.playNum&&(player2.lives=0),gameState=GAME_STATE_MENU)}function nextLevel(){22==++level&&(level=1),initObject(),1==menu.playNum&&(player2.lives=0),stage.init(level),gameState=GAME_STATE_INIT}function preLevel(){0==--level&&(level=21),initObject(),1==menu.playNum&&(player2.lives=0),stage.init(level),gameState=GAME_STATE_INIT}function drawProp(){Math.random()<.4&&null==prop&&(prop=new Prop(overCtx)).init(),null!=prop&&(prop.draw(),prop.isDestroyed&&(prop=null,propTime=1e3))}function homeNoProtected(){map.updateMap([[23,11],[23,12],[23,13],[23,14],[24,11],[24,14],[25,11],[25,14]],WALL)}$(document).ready(function(){initScreen(),initObject(),setInterval(gameLoop,20)}),$(document).keydown(function(e){switch(gameState){case GAME_STATE_MENU:if(e.keyCode==keyboard.ENTER)gameState=GAME_STATE_INIT,1==menu.playNum&&(player2.lives=0);else{var a=0;e.keyCode==keyboard.DOWN?a=1:e.keyCode==keyboard.UP&&(a=-1),menu.next(a)}break;case GAME_STATE_START:keys.contain(e.keyCode)||keys.push(e.keyCode),e.keyCode==keyboard.SPACE&&0<player1.lives?player1.shoot(BULLET_TYPE_PLAYER):e.keyCode==keyboard.ENTER&&0<player2.lives?player2.shoot(BULLET_TYPE_ENEMY):e.keyCode==keyboard.N?nextLevel():e.keyCode==keyboard.P&&preLevel()}}),$(document).keyup(function(e){keys.remove(e.keyCode)});